#!/usr/bin/env bash
# =============================================================================
# Pre-Commit Build Validation Hook
# =============================================================================
# Validates that critical builds pass and submodules are clean.
# 
# INSTALLATION:
#   Run scripts/setup-hooks.sh
#
# SKIP HOOK (for emergency):
#   git commit --no-verify -m "message"
# =============================================================================

set -uo pipefail

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
ROOT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"

cd "$ROOT_DIR"

echo "üîç Running pre-commit build validation..."
echo ""

FAILURES=0
WARNINGS=0

# -----------------------------------------------------------------------------
# 1. TypeScript Contracts Tests (Fast, Critical)
# -----------------------------------------------------------------------------
echo "1) Testing talos-contracts/typescript..."
if [[ -d "deploy/repos/talos-contracts/typescript" ]]; then
    cd "deploy/repos/talos-contracts/typescript"
    TEST_OUTPUT=$(npm test 2>&1 || true)
    if echo "$TEST_OUTPUT" | grep -iq "passed\|pass"; then
        echo "   ‚úÖ Contracts tests pass"
    else
        echo "   ‚ùå Contracts tests FAILED"
        FAILURES=$((FAILURES + 1))
    fi
    cd "$ROOT_DIR"
else
    echo "   ‚ö†Ô∏è  Contracts not found (skipped)"
    WARNINGS=$((WARNINGS + 1))
fi

# -----------------------------------------------------------------------------
# 2. Dashboard Build (Medium, Critical)
# -----------------------------------------------------------------------------
echo "2) Building talos-dashboard..."
if [[ -d "deploy/repos/talos-dashboard" ]]; then
    cd "deploy/repos/talos-dashboard"
    BUILD_OUTPUT=$(npm run build 2>&1 || true)
    if echo "$BUILD_OUTPUT" | grep -q "Compiled successfully"; then
        echo "   ‚úÖ Dashboard builds"
    else
        echo "   ‚ùå Dashboard build FAILED"
        FAILURES=$((FAILURES + 1))
    fi
    cd "$ROOT_DIR"
else
    echo "   ‚ö†Ô∏è  Dashboard not found (skipped)"
    WARNINGS=$((WARNINGS + 1))
fi

# -----------------------------------------------------------------------------
# 3. Site Build (Fast)
# -----------------------------------------------------------------------------
echo "3) Building talos-site..."
if [[ -d "deploy/repos/talos-site" ]]; then
    cd "deploy/repos/talos-site"
    BUILD_OUTPUT=$(npm run build 2>&1 || true)
    if echo "$BUILD_OUTPUT" | grep -q "Compiled successfully"; then
        echo "   ‚úÖ Site builds"
    else
        echo "   ‚ùå Site build FAILED"
        FAILURES=$((FAILURES + 1))
    fi
    cd "$ROOT_DIR"
else
    echo "   ‚ö†Ô∏è  Site not found (skipped)"
    WARNINGS=$((WARNINGS + 1))
fi

# -----------------------------------------------------------------------------
# 4. Boundary Purity Check (Fast, Critical)
# -----------------------------------------------------------------------------
echo "4) Checking contract boundaries..."
if [[ -f "deploy/scripts/check_boundaries.sh" ]]; then
    BOUNDARY_OUTPUT=$(bash deploy/scripts/check_boundaries.sh 2>&1 || true)
    if echo "$BOUNDARY_OUTPUT" | grep -q "PASS"; then
        echo "   ‚úÖ Boundary check passes"
    else
        echo "   ‚ùå Boundary check FAILED"
        FAILURES=$((FAILURES + 1))
    fi
else
    echo "   ‚ö†Ô∏è  Boundary script not found (skipped)"
    WARNINGS=$((WARNINGS + 1))
fi

# -----------------------------------------------------------------------------
# 5. Manifest Validation (Fast, Critical)
# -----------------------------------------------------------------------------
echo "5) Validating SDK manifests..."
if [[ -f "deploy/scripts/validate_manifests.py" ]]; then
    # Check for python3
    if command -v python3 >/dev/null 2>&1; then
        # Check dependencies
        if python3 -c "import jsonschema" 2>/dev/null && (python3 -c "import tomllib" 2>/dev/null || python3 -c "import toml" 2>/dev/null); then
            MANIFEST_OUTPUT=$(python3 deploy/scripts/validate_manifests.py 2>&1 || true)
            if echo "$MANIFEST_OUTPUT" | grep -q "All SDK Manifests Validated Successfully"; then
                echo "   ‚úÖ Manifests valid"
            else
                echo "   ‚ùå Manifest validation FAILED"
                echo "$MANIFEST_OUTPUT" | grep -E "‚ùå|ERROR|Error" | sed 's/^/      /'
                FAILURES=$((FAILURES + 1))
            fi
        else
            echo "   ‚ö†Ô∏è  Missing python dependencies (jsonschema, toml) - run 'pip install -r deploy/repos/talos-contracts/requirements.txt' (skipped)"
            WARNINGS=$((WARNINGS + 1))
        fi
    else
        echo "   ‚ö†Ô∏è  python3 not found (skipped)"
        WARNINGS=$((WARNINGS + 1))
    fi
else
    echo "   ‚ö†Ô∏è  Manifest script not found (skipped)"
    WARNINGS=$((WARNINGS + 1))
fi

# -----------------------------------------------------------------------------
# 6. Submodule Validation (Orchestrated)
# -----------------------------------------------------------------------------
echo "6) Checking submodules..."
# Check for changes in submodules and trigger their hooks
SUBMODULES=("deploy/repos/talos-contracts" "deploy/repos/talos-sdk-py" "deploy/repos/talos-sdk-go" "deploy/repos/talos-sdk-java")

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only)

for path in "${SUBMODULES[@]}"; do
    if echo "$STAGED_FILES" | grep -q "^$path/"; then
        echo "   üëâ Changes detected in $(basename $path)..."
        if [[ -f "$path/scripts/pre-commit" ]]; then
            # Run hook in subshell
            if (cd "$path" && bash scripts/pre-commit); then
                echo "   ‚úÖ $(basename $path) passed"
            else
                echo "   ‚ùå $(basename $path) FAILED"
                FAILURES=$((FAILURES + 1))
            fi
        else
             echo "   ‚ö†Ô∏è  No hook found in $(basename $path) (skipped)"
             WARNINGS=$((WARNINGS + 1))
        fi
    fi
done

# -----------------------------------------------------------------------------
# Result
# -----------------------------------------------------------------------------
echo ""
if [[ $FAILURES -gt 0 ]]; then
    echo "=========================================="
    echo "‚ùå COMMIT BLOCKED: $FAILURES build failure(s)"
    echo "=========================================="
    echo "Fix the issues above and try again."
    echo "To skip validation: git commit --no-verify"
    exit 1
fi

if [[ $WARNINGS -gt 0 ]]; then
    echo "=========================================="
    echo "‚ö†Ô∏è  COMMIT OK with $WARNINGS warning(s)"
    echo "=========================================="
else
    echo "=========================================="
    echo "‚úÖ All pre-commit checks passed"
    echo "=========================================="
fi

exit 0
