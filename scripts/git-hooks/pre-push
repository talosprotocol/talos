#!/bin/sh
set -e

# ANSI colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
NC='\033[0m' # No Color

echo "--------------------------------------------------------"
echo "Running pre-push quality checks..."
echo "--------------------------------------------------------"

# 1. Lint checks
echo "\n[1/3] Running Lint checks (ruff)..."
if ruff check src/ tests/ examples/; then
    echo "${GREEN}✓ Lint passed.${NC}"
else
    echo "${RED}✗ Lint failed. Please fix violations before pushing.${NC}"
    exit 1
fi

# 2. Complexity checks (radon)
echo "\n[2/3] Running Complexity checks (radon)..."
# Count high-complexity functions (Grade C or worse)
HIGH_CC=$(radon cc src/ -nc -a 2>/dev/null | grep -c " - [CDF] " || true)
AVG_CC=$(radon cc src/ -a -s 2>/dev/null | grep "Average complexity:" | grep -oE "\([0-9.]+" | tr -d '(' || echo "0")

if [ "$HIGH_CC" -gt 30 ]; then
    echo "${RED}✗ Complexity failed: $HIGH_CC high-complexity functions (> 30 max).${NC}"
    exit 1
elif [ "$HIGH_CC" -gt 20 ]; then
    echo "${YELLOW}⚠ Warning: $HIGH_CC high-complexity functions (consider refactoring).${NC}"
fi
echo "${GREEN}✓ Complexity passed (avg: $AVG_CC, high-CC: $HIGH_CC).${NC}"

# 3. Coverage checks
echo "\n[3/3] Running Coverage checks (Target: 80%)..."
# Run pytest with coverage and fail under 80%
if pytest --cov=src --cov-fail-under=80 tests/ > /dev/null 2>&1; then
     echo "${GREEN}✓ Coverage check passed (>= 80%).${NC}"
else
     echo "${RED}✗ Coverage check failed (< 80%).${NC}"
     echo "Running again to show report:"
     pytest --cov=src --cov-fail-under=80 --cov-report=term-missing tests/
     exit 1
fi

echo "\n${GREEN}All checks passed. Pushing...${NC}"
echo "--------------------------------------------------------"
