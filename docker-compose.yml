# Talos Protocol - Docker Compose
# Complete stack for demo and production deployment
# Run: docker-compose up -d

version: "3.8"

services:
  # ================================
  # Talos Gateway (API)
  # ================================
  talos-gateway:
    build:
      context: .
      dockerfile: services/gateway/Dockerfile
    container_name: talos-gateway
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      - TALOS_GATEWAY_PORT=8080
      - TALOS_ENV=production
    networks:
      - talos-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ================================
  # Talos Dashboard (Frontend)
  # ================================
  talos-dashboard:
    build:
      context: .
      dockerfile: site/dashboard/Dockerfile
    container_name: talos-dashboard
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://talos-gateway:8080
      - NEXT_PUBLIC_TALOS_DATA_MODE=HTTP
    depends_on:
      - talos-gateway
    networks:
      - talos-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ================================
  # Talos MCP Connector
  # ================================
  talos-mcp-connector:
    build:
      context: .
      dockerfile: services/mcp-connector/Dockerfile
    container_name: talos-mcp-connector
    restart: unless-stopped
    ports:
      - "8082:8082"
    environment:
      - TALOS_MCP_PORT=8082
    networks:
      - talos-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8082/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ================================
  # Talos Audit Service
  # ================================
  talos-audit-service:
    build:
      context: .
      dockerfile: services/audit/Dockerfile
    container_name: talos-audit-service
    restart: unless-stopped
    ports:
      - "8081:8000"
    environment:
      - TALOS_AUDIT_PORT=8081
    networks:
      - talos-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ================================
  # Ollama (AI Backend - Optional)
  # ================================
  ollama:
    image: ollama/ollama:latest
    container_name: talos-ollama
    restart: unless-stopped
    ports:
      - "11434:11434"
    volumes:
      - ollama-models:/root/.ollama
    networks:
      - talos-network
    profiles:
      - ai
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

# ================================
# Volumes
# ================================
volumes:
  ollama-models:
    driver: local

# ================================
# Networks
# ================================
networks:
  talos-network:
    driver: bridge
