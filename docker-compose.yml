version: "3.8"

services:
  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: talos-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: talos
      POSTGRES_USER: talos
      POSTGRES_PASSWORD: talos_dev_password
    ports:
      - "5433:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - talos-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U talos"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Gateway Service
  talos-gateway:
    build:
      context: .
      dockerfile: services/gateway/Dockerfile
      args:
        GIT_SHA: ${GIT_SHA:-unknown}
        VERSION: ${VERSION:-dev}
        BUILD_TIME: ${BUILD_TIME:-unknown}
    container_name: talos-gateway
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      - DEV_MODE=false
      - TALOS_DATABASE_URL=postgresql://talos:talos_dev_password@postgres:5432/talos
      - PORT=8080
      - TALOS_STORAGE_TYPE=postgres
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - talos-network
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import urllib.request; urllib.request.urlopen(\"http://localhost:8080/healthz\")'"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Audit Service
  talos-audit-service:
    build:
      context: .
      dockerfile: services/audit/Dockerfile
      args:
        GIT_SHA: ${GIT_SHA:-unknown}
        VERSION: ${VERSION:-dev}
        BUILD_TIME: ${BUILD_TIME:-unknown}
    container_name: talos-audit-service
    restart: unless-stopped
    ports:
      - "8081:8001"
    environment:
      - DEV_MODE=false
      - TALOS_DATABASE_URL=postgresql://talos:talos_dev_password@postgres:5432/talos
      - PORT=8001
      - TALOS_STORAGE_TYPE=postgres
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - talos-network
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import urllib.request; urllib.request.urlopen(\"http://localhost:8001/health\")'"]
      interval: 10s
      timeout: 5s
      retries: 3

  # MCP Connector
  talos-aiops:
    build:
      context: services/aiops/api
      dockerfile: Dockerfile
    container_name: talos-aiops
    ports:
      - "8200:8200"
    environment:
      - AUDIT_SERVICE_URL=http://talos-audit-service:8001
    depends_on:
      talos-audit-service:
        condition: service_started
    networks:
      - talos-network
    volumes:
      - ./data/aiops:/data

  talos-mcp-connector:
    build:
      context: .
      dockerfile: services/mcp-connector/Dockerfile
      args:
        GIT_SHA: ${GIT_SHA:-unknown}
        VERSION: ${VERSION:-dev}
        BUILD_TIME: ${BUILD_TIME:-unknown}
    container_name: talos-mcp-connector
    restart: unless-stopped
    ports:
      - "8082:8082"
    environment:
      - DEV_MODE=false
      - PORT=8082
    networks:
      - talos-network
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import urllib.request; urllib.request.urlopen(\"http://localhost:8082/health\")'"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Dashboard
  talos-dashboard:
    build:
      context: .
      dockerfile: site/dashboard/Dockerfile
      args:
        GIT_SHA: ${GIT_SHA:-unknown}
        VERSION: ${VERSION:-dev}
        BUILD_TIME: ${BUILD_TIME:-unknown}
        NEXT_PUBLIC_API_URL: http://localhost:8080
        NEXT_PUBLIC_AUDIT_URL: http://localhost:8081
        NEXT_PUBLIC_MCP_URL: http://localhost:8082
        NEXT_PUBLIC_DEV_MODE: "false"
    container_name: talos-dashboard
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      # Client-side env vars (for browser)
      - NEXT_PUBLIC_API_URL=http://localhost:8080
      - NEXT_PUBLIC_AUDIT_URL=http://localhost:8081
      - NEXT_PUBLIC_MCP_URL=http://localhost:8082
      - NEXT_PUBLIC_DEV_MODE=false
      - NEXT_PUBLIC_TALOS_DATA_MODE=HTTP
      # Server-side env vars (for SSR/API routes - uses Docker network)
      - TALOS_GATEWAY_URL=http://talos-gateway:8080
      - TALOS_AUDIT_URL=http://talos-audit-service:8001
      - TALOS_CONNECTOR_URL=http://talos-mcp-connector:8082
      - TALOS_CHAT_URL=http://talos-chat-agent:8090
      - AUTH_SECRET=production_secret_change_me_in_prod_env
      - ADMIN_EMAIL=admin@talos.security
      - ADMIN_PASSWORD=talos_secure_start
      - AUTH_TRUST_HOST=true
      - OLLAMA_URL=http://ollama:11434
    depends_on:
      - talos-gateway
      - talos-audit-service
    networks:
      - talos-network

  # Ollama AI Backend
  talos-chat-agent:
    build:
      context: ./services/ai-chat-agent/api
    hostname: talos-chat-agent
    ports:
      - "8090:8090"
    environment:
      - EXAMPLES_MODE=released
      - OLLAMA_URL=http://ollama:11434
    networks:
      - talos-network
    depends_on:
      ollama:
        condition: service_started
    volumes:
      - ./services/ai-chat-agent/api/src:/app/src

  ollama:
    image: ollama/ollama:latest
    container_name: talos-ollama
    restart: unless-stopped
    ports:
      - "11434:11434"
    volumes:
      - ollama-models:/root/.ollama
    networks:
      - talos-network
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:11434/api/tags || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Tools & SDKs
  talos-tui:
    build:
      context: tools/talos-tui
      dockerfile: Dockerfile
    container_name: talos-tui
    profiles: ["tools"]
    stdin_open: true # tty
    tty: true        # tty
    environment:
      - TALOS_GATEWAY_URL=http://talos-gateway:8080
      - TALOS_AUDIT_URL=http://talos-audit-service:8001
    networks:
      - talos-network

  talos-sdk-go-demo:
    build:
      context: .
      dockerfile: sdks/go/Dockerfile
    container_name: talos-sdk-go
    profiles: ["sdks"]
    networks:
      - talos-network
    command: go test ./...

  talos-sdk-ts-demo:
    image: node:18-alpine
    container_name: talos-sdk-ts
    profiles: ["sdks"]
    working_dir: /app
    volumes:
      - ./sdks/typescript:/app
    command: sh -c "npm install && npm test"
    networks:
      - talos-network

volumes:
  postgres-data:
    driver: local
  ollama-models:
    driver: local

networks:
  talos-network:
    driver: bridge
