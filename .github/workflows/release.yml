# Talos Protocol - Auto Release
# Creates a GitHub Release when a version tag is pushed
# This triggers deploy.yml (PyPI) and docker.yml (ghcr.io)

name: Auto Release

on:
    push:
        tags:
            - "v*"

permissions:
    contents: write

jobs:
    create-release:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Extract version from tag
              id: version
              run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

            - name: Generate changelog
              id: changelog
              run: |
                  # Get commits since last tag
                  PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
                  if [ -n "$PREV_TAG" ]; then
                    CHANGELOG=$(git log --oneline $PREV_TAG..HEAD --pretty=format:"- %s")
                  else
                    CHANGELOG=$(git log --oneline -10 --pretty=format:"- %s")
                  fi

                  # Write to file for release body
                  echo "## What's Changed" > /tmp/changelog.md
                  echo "" >> /tmp/changelog.md
                  echo "$CHANGELOG" >> /tmp/changelog.md
                  echo "" >> /tmp/changelog.md
                  echo "## Docker Images" >> /tmp/changelog.md
                  echo "" >> /tmp/changelog.md
                  echo "Pull the images:" >> /tmp/changelog.md
                  echo '```bash' >> /tmp/changelog.md
                  echo "docker pull ghcr.io/talosprotocol/talos-gateway:${{ steps.version.outputs.version }}" >> /tmp/changelog.md
                  echo "docker pull ghcr.io/talosprotocol/talos-dashboard:${{ steps.version.outputs.version }}" >> /tmp/changelog.md
                  echo "docker pull ghcr.io/talosprotocol/talos-mcp-connector:${{ steps.version.outputs.version }}" >> /tmp/changelog.md
                  echo "docker pull ghcr.io/talosprotocol/talos-audit-service:${{ steps.version.outputs.version }}" >> /tmp/changelog.md
                  echo '```' >> /tmp/changelog.md

            - name: Create Release
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: ${{ github.ref_name }}
                  name: "Talos v${{ steps.version.outputs.version }}"
                  body_path: /tmp/changelog.md
                  draft: false
                  prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
                  generate_release_notes: true
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
