name: CI

on:
  pull_request:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      release:
        description: "Run release tagging/publishing jobs"
        type: boolean
        default: false

jobs:
  canonical-golden:
    name: Canonical & Micro-Vector Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.SUBMODULE_SYNC_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Check for submodule drift
        continue-on-error: true
        run: |
          if [ -f "./scripts/check_submodule_drift.sh" ]; then
            ./scripts/check_submodule_drift.sh
          else
            echo "check_submodule_drift.sh not found, skipping check"
          fi

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install contracts
        run: |
          cd contracts/typescript
          npm ci

      - name: Run micro-vector tests
        run: |
          cd contracts/typescript
          npm test -- --run test/micro-vectors.test.ts 2>/dev/null || echo "Micro-vector tests not found, skipping"

  verify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.SUBMODULE_SYNC_TOKEN || secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Ensure submodules are initialized
        run: git submodule update --init --recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install test dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest-asyncio

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://npm.pkg.github.com"

      - name: Configure npm for private packages
        run: |
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.NPM_TOKEN }}" >> ~/.npmrc
          echo "@talosprotocol:registry=https://npm.pkg.github.com" >> ~/.npmrc
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.NPM_TOKEN }}" > deploy/repos/talos-dashboard/.npmrc
          echo "@talosprotocol:registry=https://npm.pkg.github.com" >> deploy/repos/talos-dashboard/.npmrc

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          cache: false

      - name: Verify Manifests & Run Full Coverage Suite
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          # Environment variables required for SDK/Gateway tests if any
        run: |
          chmod +x scripts/bash/run_coverage.sh
          ./scripts/bash/run_coverage.sh

  release:
    needs: verify
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && inputs.release == 'true'
    permissions:
      contents: write
    outputs:
      version: ${{ steps.get_version.outputs.VERSION }}
      tag_exists: ${{ steps.check_tag.outputs.exists }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.SUBMODULE_SYNC_TOKEN || secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Calculate next version
        id: get_version
        run: |
          # Get the latest tag (sorted by version number)
          git fetch --tags
          LATEST_TAG=$(git tag -l 'v*' | sort -V | tail -1)

          if [ -z "$LATEST_TAG" ]; then
            # No tags exist, start at 3.4.0
            VERSION="3.4.0"
          else
            # Extract version number and increment patch
            CURRENT=${LATEST_TAG#v}
            MAJOR=$(echo $CURRENT | cut -d. -f1)
            MINOR=$(echo $CURRENT | cut -d. -f2)
            PATCH=$(echo $CURRENT | cut -d. -f3)
            NEXT_PATCH=$((PATCH + 1))
            VERSION="${MAJOR}.${MINOR}.${NEXT_PATCH}"
          fi

          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Calculated next version: $VERSION (from tag: ${LATEST_TAG:-none})"

      - name: Check and Push Tag
        id: check_tag
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          TAG="v$VERSION"

          git fetch --tags
          if git rev-parse "origin/$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG already exists on remote. Skipping."
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "Creating tag $TAG"
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git tag -a "$TAG" -m "Release $TAG"
            git push origin "$TAG"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        if: steps.check_tag.outputs.exists == 'false'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.get_version.outputs.VERSION }}
          name: Talos v${{ steps.get_version.outputs.VERSION }}
          generate_release_notes: true
          draft: false
          prerelease: false

  #   docker-build:
  #     needs: release
  #     if: needs.release.outputs.tag_exists == 'false'
  #     permissions:
  #       contents: read
  #       packages: write
  #     uses: ./.github/workflows/docker.yml
  #     with:
  #       version: v${{ needs.release.outputs.version }}
  #     secrets: inherit

  # PyPI publishing is now handled exclusively by publish-packages.yml workflow
  # which triggers on release:published events. This prevents duplicate publishes.
  # See: .github/workflows/publish-packages.yml

  # pypi-deploy:
  #   needs: release
  #   runs-on: ubuntu-latest
  #   if: needs.release.result == 'success' && needs.release.outputs.tag_exists == 'false'
  #   environment:
  #     name: pypi
  #     url: https://pypi.org/p/talos-protocol
  #   permissions:
  #     contents: read
  #     id-token: write # Required for OIDC trusted publishing
  #   steps:
  #     - uses: actions/checkout@v4
  #
  #     - name: Set up Python
  #       uses: actions/setup-python@v5
  #       with:
  #         python-version: "3.11"
  #
  #     - name: Install dependencies
  #       run: |
  #         python -m pip install --upgrade pip
  #         pip install build
  #
  #     - name: Build package
  #       run: python -m build
  #
  #     - name: Publish to PyPI
  #       uses: pypa/gh-action-pypi-publish@release/v1
  #       # Uses OIDC trusted publishing - no password/token needed
