name: CI

on:
  pull_request:
  push:
    branches: [main]

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive # Uses GITHUB_TOKEN for auth automatically
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install test dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest-asyncio

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://npm.pkg.github.com"

      - name: Configure npm for private packages
        run: |
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.NPM_TOKEN }}" >> ~/.npmrc
          echo "@talosprotocol:registry=https://npm.pkg.github.com" >> ~/.npmrc

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Verify submodules initialized
        run: |
          for repo in talos-contracts talos-core-rs talos-sdk-py talos-sdk-ts talos-gateway talos-audit-service talos-mcp-connector talos-dashboard; do
            if [ ! -d "deploy/repos/$repo/.git" ] && ! git submodule status "deploy/repos/$repo" >/dev/null 2>&1; then
              echo "✖ Submodule not initialized: $repo"
              exit 1
            fi
            echo "✓ $repo initialized"
          done

      - name: Contract boundary purity gate
        run: bash deploy/scripts/check_boundaries.sh

      - name: Verify test vectors
        run: bash deploy/scripts/ci_verify_vectors.sh

      - name: Run master test runner
        run: bash deploy/scripts/run_all_tests.sh --skip-build
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
