name: CI

on:
  pull_request:
  push:
    branches: [main]

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive # Uses GITHUB_TOKEN for auth automatically
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install test dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest-asyncio

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://npm.pkg.github.com"

      - name: Configure npm for private packages
        run: |
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.NPM_TOKEN }}" >> ~/.npmrc
          echo "@talosprotocol:registry=https://npm.pkg.github.com" >> ~/.npmrc
          # Also write to dashboard directory for submodule tests
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.NPM_TOKEN }}" > deploy/repos/talos-dashboard/.npmrc
          echo "@talosprotocol:registry=https://npm.pkg.github.com" >> deploy/repos/talos-dashboard/.npmrc

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Verify submodules initialized
        run: |
          for repo in talos-contracts talos-core-rs talos-sdk-py talos-sdk-ts talos-gateway talos-audit-service talos-mcp-connector talos-dashboard; do
            if [ ! -d "deploy/repos/$repo/.git" ] && ! git submodule status "deploy/repos/$repo" >/dev/null 2>&1; then
              echo "✖ Submodule not initialized: $repo"
              exit 1
            fi
            echo "✓ $repo initialized"
          done

      - name: Contract boundary purity gate
        run: bash deploy/scripts/check_boundaries.sh

      - name: Verify test vectors
        run: bash deploy/scripts/ci_verify_vectors.sh

      - name: Run master test runner
        run: bash deploy/scripts/run_all_tests.sh --skip-build
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

  release:
    needs: verify
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: write
    outputs:
      version: ${{ steps.get_version.outputs.VERSION }}
      tag_exists: ${{ steps.check_tag.outputs.exists }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Get version
        id: get_version
        run: |
          # Extract version from gateway pyproject.toml
          VERSION=$(grep -m1 'version = "' deploy/repos/talos-gateway/pyproject.toml | cut -d '"' -f 2)
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Detected version: $VERSION"

      - name: Check and Push Tag
        id: check_tag
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          TAG="v$VERSION"

          if git rev-parse "origin/$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG already exists on remote. Skipping."
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "Creating tag $TAG"
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git tag -a "$TAG" -m "Release $TAG"
            git push origin "$TAG"
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        if: steps.check_tag.outputs.exists == 'false'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.get_version.outputs.VERSION }}
          name: Talos v${{ steps.get_version.outputs.VERSION }}
          generate_release_notes: true
          draft: false
          prerelease: false

  docker-build:
    needs: release
    if: needs.release.outputs.tag_exists == 'false'
    uses: ./.github/workflows/docker.yml
    with:
      version: v${{ needs.release.outputs.version }}
    secrets: inherit

  pypi-deploy:
    needs: release
    if: needs.release.outputs.tag_exists == 'false'
    uses: ./.github/workflows/deploy.yml
    with:
      version: v${{ needs.release.outputs.version }}
    secrets: inherit
