name: Universal Service CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  service-build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - service: services/gateway
            name: talos-gateway
            language: python
            version: "3.11"

          - service: services/ai-gateway
            name: talos-ai-gateway
            language: python
            version: "3.11"

          - service: services/audit
            name: talos-audit-service
            language: python
            version: "3.11"

          - service: services/mcp-connector
            name: talos-mcp-connector
            language: python
            version: "3.11"

          - service: services/ucp-connector
            name: talos-ucp-connector
            language: python
            version: "3.11"

          - service: services/ai-chat-agent/api
            name: talos-ai-chat-agent
            language: python
            version: "3.11"

          - service: services/aiops/api
            name: talos-aiops
            language: python
            version: "3.11"

          - service: services/governance-agent
            name: talos-governance-agent
            language: python
            version: "3.11"

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.SUBMODULE_SYNC_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Set up Python
        if: matrix.language == 'python'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.version }}

      - name: Install & Validate
        run: |
          cd ${{ matrix.service }}
          echo "Processing service in $(pwd)"

          if [ -f "Makefile" ]; then
            echo "Makefile found, running standard targets..."
            make install lint typecheck test
          elif [ -f "pyproject.toml" ]; then
            echo "pyproject.toml found, installing with pip..."
            pip install .[test] || pip install .
            if [ -d "tests" ]; then
              pytest || true
            else
              echo "No tests directory found, skipping pytest."
            fi
          elif [ -f "requirements.txt" ]; then
            echo "requirements.txt found, installing with pip..."
            pip install -r requirements.txt
            if [ -d "tests" ]; then
              pytest || true
            else
              echo "No tests directory found, skipping pytest."
            fi
          else
            echo "::error::No known build system found in ${{ matrix.service }}"
            exit 1
          fi
