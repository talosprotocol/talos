name: Universal SDK CI

on:
    push:
        branches: ["main"]
    pull_request:
        branches: ["main"]
    workflow_dispatch:

jobs:
    # 1. Validate Contracts (Source of Truth)
    contracts-validate:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
              with:
                  submodules: recursive
                  token: ${{ secrets.SUBMODULE_SYNC_TOKEN || secrets.GITHUB_TOKEN }}

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.10"

            - name: Install Contract Deps
              run: |
                  cd deploy/repos/talos-contracts
                  pip install -r requirements.txt

            - name: Typecheck Contracts (Spec Validation)
              run: |
                  cd deploy/repos/talos-contracts
                  make typecheck

    # 2. Validate Manifest Boundary (Compatibility)
    manifests-validate:
        needs: contracts-validate
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
              with:
                  submodules: recursive
                  token: ${{ secrets.SUBMODULE_SYNC_TOKEN || secrets.GITHUB_TOKEN }}

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.10"

            - name: Install Validators
              run: pip install jsonschema toml types-toml

            - name: Validate Manifests & Hashes
              run: python3 deploy/scripts/validate_manifests.py

    # 3. Universal SDK Build Matrix
    sdk-build:
        needs: manifests-validate
        runs-on: ubuntu-latest
        strategy:
            fail-fast: false
            matrix:
                include:
                    - repo: talos-sdk-py
                      language: python
                      version: "3.10"
                      cmd: make install lint typecheck test conformance

                    - repo: talos-sdk-ts
                      language: node
                      version: "20"
                      cmd: make install lint typecheck test conformance

                    - repo: talos-sdk-java
                      language: java
                      version: "21"
                      cmd: make install lint typecheck test conformance

                    - repo: talos-sdk-go
                      language: go
                      version: "1.21"
                      cmd: make install lint typecheck test conformance

                    - repo: talos-core-rs
                      language: rust
                      version: "stable"
                      cmd: make lint test conformance

        steps:
            - uses: actions/checkout@v4
              with:
                  submodules: recursive
                  token: ${{ secrets.SUBMODULE_SYNC_TOKEN || secrets.GITHUB_TOKEN }}

            # Dynamic Setup based on Matrix
            - name: Set up Python
              if: matrix.language == 'python'
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ matrix.version }}

            - name: Set up Node
              if: matrix.language == 'node'
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ matrix.version }}

            - name: Set up Java
              if: matrix.language == 'java'
              uses: actions/setup-java@v4
              with:
                  distribution: "temurin"
                  java-version: ${{ matrix.version }}

            - name: Set up Go
              if: matrix.language == 'go'
              uses: actions/setup-go@v5
              with:
                  go-version: ${{ matrix.version }}

            - name: Set up Rust
              if: matrix.language == 'rust'
              uses: dtolnay/rust-toolchain@stable
              with:
                  toolchain: ${{ matrix.version }}

            # Universal Execution
            - name: Run Standard Gates
              run: |
                  cd deploy/repos/${{ matrix.repo }}
                  ${{ matrix.cmd }}
