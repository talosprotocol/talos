name: DCO Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  dco-check:
    name: DCO Sign-off Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
          with:
            submodules: recursive
            token: ${{ secrets.SUBMODULE_SYNC_TOKEN || secrets.GITHUB_TOKEN }}
        with:
          submodules: recursive
          token: ${{ secrets.SUBMODULE_SYNC_TOKEN || secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Check DCO Sign-off
        run: |
          # Get commits in this PR
          commits=$(git log --format="%H" origin/${{ github.base_ref }}..${{ github.head_ref }} 2>/dev/null || git log --format="%H" -10)

          failed=0
          for commit in $commits; do
            if ! git log -1 --format="%B" "$commit" | grep -q "^Signed-off-by:"; then
              echo "Missing DCO sign-off in commit: $commit"
              git log -1 --format="%s" "$commit"
              failed=1
            fi
          done

          if [ "$failed" -eq 1 ]; then
            echo ""
            echo "ERROR: Some commits are missing DCO sign-off."
            echo "Please add 'Signed-off-by: Your Name <email>' to your commit messages."
            echo "You can use 'git commit --amend -s' to add it to the last commit."
            exit 1
          fi

          echo "All commits have DCO sign-off!"
